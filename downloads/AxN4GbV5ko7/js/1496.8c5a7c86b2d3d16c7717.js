"use strict";(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[1496],{76185:(e,t,i)=>{function o(e){if(null==e)throw new Error(`Expected a defined value but got ${e} instead`)}i.d(t,{$:()=>o})},15934:(e,t,i)=>{var o;i.d(t,{A:()=>s}),function(e){e[e.GL_TEXTURE_CUBE_MAP_POSITIVE_X=0]="GL_TEXTURE_CUBE_MAP_POSITIVE_X",e[e.GL_TEXTURE_CUBE_MAP_NEGATIVE_X=1]="GL_TEXTURE_CUBE_MAP_NEGATIVE_X",e[e.GL_TEXTURE_CUBE_MAP_POSITIVE_Y=2]="GL_TEXTURE_CUBE_MAP_POSITIVE_Y",e[e.GL_TEXTURE_CUBE_MAP_NEGATIVE_Y=3]="GL_TEXTURE_CUBE_MAP_NEGATIVE_Y",e[e.GL_TEXTURE_CUBE_MAP_POSITIVE_Z=4]="GL_TEXTURE_CUBE_MAP_POSITIVE_Z",e[e.GL_TEXTURE_CUBE_MAP_NEGATIVE_Z=5]="GL_TEXTURE_CUBE_MAP_NEGATIVE_Z"}(o||(o={}));const s=o},65936:(e,t,i)=>{i.d(t,{m:()=>s});var o=i(55141);class s extends o.u{constructor(e,t,i){super();const o=function*(){return t()}();this.payload={type:e,func:o,maxDelay:i,steps:1}}}s.id="SCHEDULE_TASK_COMMAND"},46140:(e,t,i)=>{i.d(t,{A:()=>n});var o,s=i(76318),r=i(8333);!function(e){e[e.Untested=0]="Untested",e[e.Testing=1]="Testing",e[e.Success=2]="Success",e[e.Fail=3]="Fail"}(o||(o={}));class n{constructor(e,t,i,o){this.maxCubemapSize=e,this.maxNavPanoSize=t,this.maxZoomPanoSize=i,this.overrideWindow=!1,this.navPanoSize=s.c5.STANDARD,this.zoomPanoSize=s.c5.STANDARD,this.defaultMaxNavPanoSize=this.maxNavPanoSize,this.resolution=o,this.highQualityThreshold=r.W0.windowHeightHighQualityThresholdOverride||r.W0.windowHeightHighQualityThreshold,this.updateMaximums()}update({height:e,fov:t}){this.resolution=e,this.updateMaximums()}overrideWindowMaximums(e){this.overrideWindow=e,this.updateMaximums()}overrideNavPanoSize(e){this.maxNavPanoSize=null!=e?e:this.defaultMaxNavPanoSize,this.updateMaximums()}updateMaximums(){this.resolution<this.highQualityThreshold&&!this.overrideWindow?(this.navPanoSize=Math.min(n.getPanoSize(s.MF.STANDARD),this.maxNavPanoSize),this.zoomPanoSize=Math.min(n.getPanoSize(s.MF.HIGH),this.maxZoomPanoSize)):(this.navPanoSize=this.maxNavPanoSize,this.zoomPanoSize=this.maxZoomPanoSize),this.zoomPanoSize<this.navPanoSize&&(this.navPanoSize=this.zoomPanoSize),this.zoomPanoSize=Math.min(this.maxCubemapSize,this.zoomPanoSize),this.navPanoSize=Math.min(this.maxCubemapSize,this.navPanoSize)}static getPanoSize(e){if(e in s.oY)return s.oY[e];throw new Error(`Not a panoSizeClass: ${e}`)}static getPanoSizeClass(e){if(e in s.Mo)return s.Mo[e];throw new Error(`Not a valid pano resolution: ${e}`)}getNavPanoSize(){return this.navPanoSize}getZoomPanoSize(){return this.zoomPanoSize}}},11018:(e,t,i)=>{i.d(t,{A:()=>s});var o=i(89103);class s extends o.QB{constructor(e,t,i){super(),this.size=e,this.sweepId=t,this.renderTarget=i}}},10574:(e,t,i)=>{i.d(t,{V:()=>s});var o=i(55141);class s extends o.u{constructor(e){super(),this.payload={navSize:e}}}s.id="SET_NAV_PANO_SIZE"},91496:(e,t,i)=>{i.r(t),i.d(t,{default:()=>Me});var o=i(75578),s=i(71687),r=i(8333),n=i(73927),a=i(68909),l=i(15934),u=i(46147);const h={0:l.A.GL_TEXTURE_CUBE_MAP_POSITIVE_Y,1:l.A.GL_TEXTURE_CUBE_MAP_POSITIVE_Z,2:l.A.GL_TEXTURE_CUBE_MAP_POSITIVE_X,3:l.A.GL_TEXTURE_CUBE_MAP_NEGATIVE_Z,4:l.A.GL_TEXTURE_CUBE_MAP_NEGATIVE_X,5:l.A.GL_TEXTURE_CUBE_MAP_NEGATIVE_Y},c=e=>{if(e<0||e>5)throw new u.A("mapFaceToCubemapFace() -> face must be in the range [0, 5]");return h[e]};var d=i(76318),p=i(50178),g=i(244),w=i(65936),T=i(48539);class f{constructor(e){this._value=e}value(){return this._value}set(e){this._value=e}}class S{constructor(){this.storage={}}get(e,t){let i=this.storage[e];return i||(i=t(),this.storage[e]=i),i}getNumber(e){return this.get(e,(()=>new f(0)))}getString(e){return this.get(e,(()=>new f("")))}getArray(e){return this.get(e,(()=>[]))}getNumberMap(e){return this.get(e,(()=>({})))}getStringMap(e){return this.get(e,(()=>({})))}}var m,D=i(73586),v=i(81662),y=i(10843),P=i(11018),z=i(46140);!function(e){e[e.Center=0]="Center",e[e.UpperLeft=1]="UpperLeft",e[e.UpperRight=2]="UpperRight",e[e.LowerRight=3]="LowerRight",e[e.LowerLeft=4]="LowerLeft"}(m||(m={}));const Q=m;var R=i(53172);const A=512,F=(e,t,i,o,s,r,n,a)=>{const u=e/t,h=2*(t/e),c=h/2;let d=2*(o/u)-1+c,p=2*((s=u-1-s)/u)-1+c;switch(r=r||Q.Center){case Q.UpperLeft:d-=c,p+=c,d+=n*h;break;case Q.UpperRight:d+=c,p+=c,p-=n*h;break;case Q.LowerRight:d+=c,p-=c,d-=n*h;break;case Q.LowerLeft:d-=c,p-=c,p+=n*h;case Q.Center:}switch(i){case l.A.GL_TEXTURE_CUBE_MAP_POSITIVE_X:a.set(-1,p,-d);break;case l.A.GL_TEXTURE_CUBE_MAP_NEGATIVE_X:a.set(1,p,d);break;case l.A.GL_TEXTURE_CUBE_MAP_POSITIVE_Y:a.set(-d,1,-p);break;case l.A.GL_TEXTURE_CUBE_MAP_NEGATIVE_Y:a.set(-d,-1,p);break;case l.A.GL_TEXTURE_CUBE_MAP_POSITIVE_Z:a.set(-d,p,1);break;case l.A.GL_TEXTURE_CUBE_MAP_NEGATIVE_Z:a.set(d,p,-1)}a.normalize()},U=(e,t)=>{let i=A;e<A&&(i=e);const o=Math.floor(e/i),s=o*o;return Math.floor(t/s)},x=(e,t,i)=>{let o=A;e<A&&(o=e);const s=U(e,t),r=Math.floor(e/o),n=t-s*(r*r);i.tileX=n%r,i.tileY=Math.floor(n/r),i.face=s,i.faceTileIndex=n},b=function(e){if(e<=A)return 6;const t=Math.floor(e/A);return 6*(t*t)},C=function(){const e=new a.Matrix4,t=new a.Quaternion;return(i,o)=>{t.copy(i),t.invert(),e.makeRotationFromQuaternion(t),o.applyMatrix4(e),o.normalize()}}(),M=function(){const e=new a.Vector3,t=new a.Vector3(0,0,-1),i=new a.Quaternion,o=function(e,t){e.push({face:t.face,faceTileIndex:t.faceTileIndex,tileX:t.tileX,tileY:t.tileY})},s=function(){const e={face:-1,faceTileIndex:-1,tileX:-1,tileY:-1};return(t,i,s)=>{const r=b(t);let n=0;for(let a=0;a<r;a++)x(t,a,e),i&&!i(e)||(n++,s&&o(s,e));return n}}();return(o,r,n,l,u=!1,h,c)=>{l.length=u?0:l.length;const d=r<A?r:A;if(!h&&!c)return s(r,null,l);const p=!!c;h=h||0,c=c||h,c=Math.max(0,Math.min(c,360)),h=Math.max(0,Math.min(h,360)),e.copy(n);const g=o.rotation||new a.Quaternion;if(C(g,e),p){i.setFromUnitVectors(e,t);return s(r,(function(e){return E(r,d,e.face,e.tileX,e.tileY,i,h||0,c||0)}),l)}return s(r,(function(t){return I(r,d,t.face,t.tileX,t.tileY,e,h||0)}),l)}}(),E=function(){const e=new a.Vector3;return(t,i,o,s,r,n,a,l)=>{const u=Math.tan(.5*l*R.fy),h=-u,d=Math.tan(.5*a*R.fy),p=-d,g=c(o);let w=0,T=0,f=0,S=0,m=0;for(let o=Q.Center;o<=Q.LowerLeft;o++){if(F(t,i,g,s,r,o,0,e),e.applyQuaternion(n),e.z>=-1e-5)continue;const a=-1/e.z,l=e.x*a,c=e.y*a;c>u?w++:c<h&&T++,l>d?f++:l<p&&S++,m++}return T!==m&&w!==m&&f!==m&&S!==m}}(),I=function(){const e=new a.Vector3,t=new a.Vector3(0,1,0),i=new a.Vector3(1,0,0);return(o,s,r,n,a,l,u)=>{const h=c(r);if(i.copy(l).cross(t),F(o,s,h,n,a,Q.Center,0,e),_(e,l,u))return!0;const d=u/360,p=Math.floor(1/d);let g=0;for(let t=0;t<p;t++){for(let t=Q.UpperLeft;t<=Q.LowerLeft;t++)if(F(o,s,h,n,a,t,g,e),_(e,l,u))return!0;g+=d}return!1}}(),_=function(){const e=new a.Vector3,t=new a.Vector3;return(i,o,s,r)=>{if(t.copy(i),r){e.copy(r),e.normalize();const o=e.dot(i);e.x*=o,e.y*=o,e.z*=o,t.sub(e)}const n=s/2*R.fy,a=Math.cos(n);return t.dot(o)>=a}}();var L;!function(e){e[e.PreOrder=0]="PreOrder",e[e.PostOrder=1]="PostOrder"}(L||(L={}));class V{constructor(e,t){this.tree=e,this.parent=t,this.children=[],this.id=++V._id,this.extra={},this.level=-1}}V._id=0;class N{constructor(e,t){this.levels=t,this.tileSize=e,this.root=null,this.allNodes=[],B(this)}getSizeForLevel(e,t){return Math.pow(2,t)*e}getSubNode(e,t,i){(!t||e<this.tileSize)&&(t=0),(!i||e<this.tileSize)&&(i=0),e<this.tileSize&&(e=this.tileSize);const o=H(this.tileSize,e);return G(this.root,0,o,t,i)}deleteAllNodes(){this.depthFirst(function(e,t,i,o,s){for(let t=0;t<e.children.length;t++){const i=e.children[t];i&&(i.parent=null,i.tree=null),e.children[t]=null}e.children.length=0}.bind(this),null,L.PostOrder);for(let e=0;e<this.allNodes.length;e++){const t=this.allNodes[e];t&&(t.parent=null,t.tree=null),this.allNodes[e]=null}this.allNodes.length=0,this.root=null}breadthFirst(e){const t=!!(e=e||{}).nullLevelEnd,i=e.maxLevel,o=e.minLevel,s=e.callback,r=e.saveVisited,n=[],a=new V(this,null);let l=0;if(this.root)for(n.push(this.root),n.push(a);n.length>0&&!(i&&l>i);){const e=n.shift();if(e)if(e===a)(!o||l>=o)&&(s&&t&&s(),r&&t&&r.push(null)),n.length>0&&n.push(a),l++;else{if(e.children)for(const t of e.children)t&&n.push(t);const t=this.getFaceIndexFromNode(e);(!o||l>=o)&&(s&&s(e,l,t),r&&r.push(e))}}}getFaceIndexFromNode(e){if(!e)return-1;let t=1,i=e,o=0,s=0;for(;;){const e=i.parent;if(!e)break;let r=-1;for(let t=0;t<e.children.length;t++)e.children[t]===i&&(r=t);o=r%2*t+o,s=Math.floor(r/2)*t+s,t*=2,i=e}return s*t+o}depthFirst(e,t,i){O(this.root,0,0,0,e,t,i,this.tileSize)}}const H=function(e,t){let i=0;for(t<e&&(t=e);!((t/=2)<e);)i++;return i},O=function(e,t,i,o,s,r,n,a){if(!e)return;const l=2*o+i;if((n=n||L.PreOrder)===L.PreOrder&&(s&&s(e,t,l,i,o),r&&r.push(e)),!e.children||0===e.children.length)return;const u=2*o,h=2*i;for(let i=0;i<2;i++)for(let o=0;o<2;o++)O(e.children[2*o+i],t+1,h+i,u+o,s,r,n,a);n===L.PostOrder&&(s&&s(e,t,l,i,o),r&&r.push(e))},B=e=>{e.root=q(e,null,0)},q=(e,t,i)=>{if(i>e.levels)return null;const o=new V(e,t);o.level=i,e.allNodes.push(o);for(let t=0;t<4;t++){const s=q(e,o,i+1);s&&(o.children[t]=s)}return o},G=(e,t,i,o,s)=>{if(!e)return null;if(0===i)return e;{if(!e.children||0===e.children.length)return null;const r=Math.pow(2,i)/2,n=o%r,a=s%r,l=2*Math.floor(s/r)+Math.floor(o/r),u=e.children[l];return G(u,t+1,i-1,n,a)}};var X,k=i(52018);class Z extends k.t{constructor(e){super(e),this.name="PanoTilingError"}}!function(e){e[e.Base=0]="Base",e[e.Remaining=1]="Remaining"}(X||(X={}));class Y{constructor(e){this.tilePrioritizer=e,this.forceQueue=[],this.uploadQueues={},this.panoLODDescriptors={}}addToForceQueue(e){this.forceQueue.push(e)}addToPanoQueue(e,t){this.getUploadQueueForPano(e).push(t)}insertSortedIntoPanoQueue(e,t,i){const o=this.getUploadQueueForPano(t.id);this.tilePrioritizer.insertSortedPanoTile(o,e,t,i)}sortQueue(e,t){const i=this.getUploadQueueForPano(e.id);this.tilePrioritizer.sortTiles(i,e,t)}getUploadQueueForPano(e){let t=this.uploadQueues[e];return t||(t=[],this.uploadQueues[e]=t),t}hasQueuedTiles(){if(this.forceQueue.length>0)return!0;for(const e in this.uploadQueues){const t=this.getUploadQueueForSweep(e);if(t&&t.length>0)return!0}return!1}getUploadQueueForSweep(e){let t=this.uploadQueues[e];return t||(t=[],this.uploadQueues[e]=t),t}getTopUploadQueue(e){let t=null;for(let i=X.Base;i<=X.Remaining;i++)for(const o of e)if(t=this.getUploadQueueForSweep(o.id),t.length>0)switch(i){case X.Base:if(0===t[0].level)return t;break;case X.Remaining:return t}return null}processNextQueueItem(e){const t=e.shift();return t?(t.uploadQueued=!1,t):null}getNextFromUploadQueue(e){if(this.forceQueue.length>0)return this.processNextQueueItem(this.forceQueue);const t=this.getTopUploadQueue(e);return t&&t.length>0?this.processNextQueueItem(t):null}peekNextFromUploadQueue(e){if(this.forceQueue.length>0)return this.forceQueue[0];const t=this.getTopUploadQueue(e);return t&&t.length>0?t[0]:null}clearAllQueuedUploads(){this.clearAllUploadQueues(null,0)}clearAllUploadQueues(e,t=0){if(e)this.clearUploadQueue(this.getUploadQueueForSweep(e),t),this.clearUploadQueue(this.forceQueue,t,e);else{for(const e in this.uploadQueues)this.clearUploadQueue(this.getUploadQueueForSweep(e),t);this.clearUploadQueue(this.forceQueue,t)}}clearUploadQueue(e,t=0,i){let o=0;for(;o<e.length;){const s=e[o];(!i||i&&i===s.sweepId)&&s.level>=t?(s.uploadQueued=!1,e.splice(o,1)):o++}}resetPanoLODDescriptors(e){const t=this.getPanoLODDescriptors(e);for(const e in t)if(t.hasOwnProperty(e)){const i=t[e];i.uploadCount=0,i.uploadAttempts=0}}getPanoLODDescriptor(e,t){const i=this.getPanoLODDescriptors(e);let o=i[t];return o||(o={uploadCount:0,uploadAttempts:0},i[t]=o),o}getPanoLODDescriptors(e){let t=this.panoLODDescriptors[e];return t||(t={},this.panoLODDescriptors[e]=t),t}}const W=new y.Ay("tiles"),j=r.W0.uploadIntervalDelay;class ${constructor(e,t,i,o,s,r,n){this.cwfRenderer=e,this.panoQualityManager=t,this.tileDownloader=i,this.tilePrioritizer=o,this.sweepData=s,this.cameraData=r,this.tilingSettings=n,this.persistentStorage=new S,this.tempTileTextures=new Map,this.componentActive=!1,this.activeSweeps=[],this.sweepLoadHistory=[],this.activeRenderTargetDescriptors={},this.panoLoadMinimumCallbacks={},this.panoLoadPromises={},this.panoLoadResolvers={},this.tileDirectory={},this.tileTrees={},this.zoomSweepRenderingDisabled=!1,this.zoomingActive=!1,this.zoomSweepId=null,this.usingTileOverlay=!1,this.overlayTilesLoaded=!1,this.overlayTiles={},this.currentState={direction:new a.Vector3,position:new a.Vector3,rotation:new a.Quaternion,sweepId:void 0},this.textureUsageCounter={},this.tileUploadQueue=new Y(this.tilePrioritizer),this.renderTargetPool=new D.i(((e,t)=>e.object.height===t.size&&e.object.width===t.size)),this.onTileDownLoaded=this.onTileDownLoaded.bind(this)}render(){}activate(e){this.engine=e,this.componentActive=!0;for(const e of this.getActivePanos())this.resetUploadState(e,!0,!0),this.clearAllQueuedUploadsForPano(e),this.renderPanoTiles(e,null,!0,!0)}deactivate(){this.clearAllQueuedUploads(),this.tempTileTextures.forEach((e=>e.dispose())),this.tempTileTextures.clear(),this.renderTargetPool.all().forEach((({object:e})=>null==e?void 0:e.dispose())),this.zoomRenderTarget.dispose(),this.componentActive=!1}dispose(){}getActivePanos(){const e=[];for(const t of Object.keys(this.activeRenderTargetDescriptors)){this.activeRenderTargetDescriptors[t]&&e.push(t)}return e}init(){this.loadOverlayTiles()}_activateSweep(e){this.textureUsageCounter[e]||(this.textureUsageCounter[e]=0)}_useTexture(e){this.textureUsageCounter[e]++}_freeTexture(e){this.textureUsageCounter[e]>0&&this.textureUsageCounter[e]--}_setTextureUsage(e,t){this.textureUsageCounter[e]=t}_freeUnusedTextures(){for(const e of Object.keys(this.textureUsageCounter))0===this.textureUsageCounter[e]&&this.freeTexture(e)}highResRenderTarget(e,t){if(e){if(!t)throw new Z("Cannot activate zooming without sweepId!");this.zoomingActive=!0,this.zoomSweepId=t,this.copyTargetToZoom(t)}else this.zoomingActive=!1,this.zoomSweepId=null;if(t){const e=this.getRenderTargetDescriptorForSweep(t);if(!e)throw new Z("Zooming at a null render target!");const i=this.zoomingActive?this.zoomRenderTarget:e.object,o=i.width;this.engine.broadcast(new P.A(o,t,i))}}getCurrentPanoResolution(){const e=this.zoomingActive?this.panoQualityManager.getZoomPanoSize():this.panoQualityManager.getNavPanoSize();return z.A.getPanoSizeClass(e)}beforeRender(){if(this.currentState.position.copy(this.cameraData.pose.position),this.currentState.rotation.copy(this.cameraData.pose.rotation),this.currentState.direction.copy(v.B1.FORWARD).applyQuaternion(this.cameraData.pose.rotation),this.tileUploadQueue.hasQueuedTiles())for(const e of this.activeSweeps)this.tileUploadQueue.sortQueue(e,this.currentState.direction);const e=this.sweepData.state.transition.to,t=this.sweepData.state.currentSweep,i=e||t||this.currentState.sweepId;i&&(this.currentState.sweepId=i);const o=i?this.sweepData.getSweep(i):null;o&&this.tilePrioritizer.updateCriteria(o,this.currentState.position,this.currentState.direction,this.currentState.rotation),this.updateUploadQueueProcessing()}activateSweep(e,t=!0){this._activateSweep(e);const i=this.sweepData.getSweep(e);if(!i)throw W.error(e,i),new Z("Invalid sweepId passed to TiledPanoRenderer.activate()");let o=this.panoLoadPromises[e];if(!o){const s=(()=>{const i=this.engine;let o;return t&&(o=window.setTimeout((()=>{i.broadcast(new p.XR(!0))}),r.W0.loadIndicatorDelay)),this._useTexture(e),()=>{clearTimeout(o),i.broadcast(new p.XR(!1)),this._freeTexture(e)}})();t&&(this.panoLoadMinimumCallbacks[e]=s),o=new Promise(((t,o)=>{this.panoLoadResolvers[e]=t,this.activatePano(i),this.queueUploadForAllTiles(e),this.tileDownloader.forceQueueTiles(i,d.c5.BASE,this.currentState.direction,!0)})),this.panoLoadPromises[e]=o}return o}useTexture(e){const t=this.getRenderTargetDescriptorForSweep(e);if(!t)throw W.error(e),new Z("Texture for sweep not activated before using");const i=t.object.texture;return this._useTexture(e),this._freeUnusedTextures(),this.zoomingActive?this.zoomRenderTarget.texture:i}freeTexture(e){this._freeTexture(e),0===this.textureUsageCounter[e]&&this.deactivatePano(e)}freeAllTextures(e=[]){const t=(0,T.Z9)(e),i=this.getActivePanos();for(const e of i)t[e]||this.freeTexture(e)}enableUltraHighQualityMode(e){this.setupZoomRenderTarget(),this.zoomSweepId&&this.engine.broadcast(new P.A(this.zoomRenderTarget.width,this.zoomSweepId,this.zoomRenderTarget))}resetRenderStatus(e,t,i,o){let s;o&&(s=H(A,o)+1);const r=(e,o,s,r)=>{i&&(o.extra.tile.zoomUploaded=!1),t&&(o.extra.tile.uploaded=!1)};for(let t=0;t<6;t++){this.getTileTree(e,t).breadthFirst({callback:r.bind(this,t),minLevel:s})}}copyBaseRenderStatusToZoomed(e){const t=H(A,this.panoQualityManager.getNavPanoSize()),i=(e,t,i,o)=>{t.extra.tile.zoomUploaded=t.extra.tile.uploaded,t.extra.zoomCovered=t.extra.covered};for(let o=0;o<6;o++){this.getTileTree(e,o).breadthFirst({callback:i.bind(this,o),maxLevel:t})}}renderPanoTiles(e,t,i,o){const s=[];this.zoomRenderTarget&&this.zoomRenderTarget.width===this.panoQualityManager.getZoomPanoSize()||this.zoomSweepRenderingDisabled||this.setupZoomRenderTarget(),t=t||this.currentState.direction||v.B1.FORWARD;const r=this.getRenderTargetDescriptorForSweep(e);if(!this.isRenderTargetDescriptorValid(r))throw new Z("PanoRenderer.renderPanoTiles() -> Cannot render to a pano that is not activated.");for(let t=0;t<6;t++){const r=this.getTileTree(e,t);s.length=0,r.breadthFirst({saveVisited:s});for(let e=0;e<s.length;e++){const t=s[e];this.queueUploadForTile(t.extra.tile,!1,o||0===e&&i)}}}clearAllQueuedUploads(){this.tileUploadQueue.clearAllUploadQueues(null,0)}clearAllQueuedUploadsForPano(e){this.tileUploadQueue.clearAllUploadQueues(e,0)}activatePano(e){this.tileUploadQueue.clearAllQueuedUploads();const t=e.availableResolution(d.MF.ULTRAHIGH),i=d.oY[t],o=e.id;for(let t=0;t<6;t++){let s=this.tileTrees[o];s||(s=[],this.tileTrees[o]=s);let r=s[t];if(!r){const o=H(A,i);r=new N(A,o),s[t]=r,r.breadthFirst({callback:(i,o,s)=>{const r=this.getTileDirectoryEntry(e.id,t,o,s);i.extra.tile=r,r.node=i}})}}let s=this.getRenderTargetDescriptorForSweep(e.id);if(!s){const t=this.panoQualityManager.getNavPanoSize();if(s=this.renderTargetPool.get({size:t}),!s){const e=this.cwfRenderer.initRenderTargetCube(t);s=this.renderTargetPool.add(e),s.extra={},s.extra.size=e.width}s.extra.sweep=e,s.extra.sweepindex=e.index,this.activeRenderTargetDescriptors[e.id]=s,this.tileUploadQueue.resetPanoLODDescriptors(e.id),this.resetUploadState(e.id,!0,!0)}return this.updateActiveSweeps(e),s.object}deactivatePano(e){const t=this.getRenderTargetDescriptorForSweep(e);t&&this.isRenderTargetDescriptorValid(t)&&(this.renderTargetPool.free(t.object),this.activeRenderTargetDescriptors[e]=null,this.updateActiveSweeps(),this.tileUploadQueue.clearAllUploadQueues(e),this.tileUploadQueue.resetPanoLODDescriptors(e),this.clearCachedTileData(),delete this.panoLoadPromises[e])}clearCachedTileData(){for(let e=this.sweepLoadHistory.length-1;e>=0;e--){let t=!1;const i=this.sweepLoadHistory[e];if(i){for(const e of this.activeSweeps)if(i===e.id){t=!0;break}t||(this.checkTileTreeInitialized(i)&&(this.clearTileState(i,!0,!0),this.deleteTileTrees(i)),this.deleteTileDirectoryEntries(i),this.tileDownloader.deleteAllTileDownloadDescriptors(i),this.sweepLoadHistory[e]=null)}}this.updateSweepLoadHistory()}updateActiveSweeps(e){const t=this.persistentStorage.getArray("updateActiveSweeps:tempSweeps");t.length=0;for(const i of this.activeSweeps){const o=this.getRenderTargetDescriptorForSweep(i.id);e&&i.id===e.id||!this.isRenderTargetDescriptorValid(o)||t.push(i)}e&&t.unshift(e),this.activeSweeps.length=0,this.activeSweeps.push(...t)}queueUploadForAllTiles(e){this.zoomRenderTarget&&this.zoomRenderTarget.width===this.panoQualityManager.getZoomPanoSize()||this.zoomSweepRenderingDisabled||this.setupZoomRenderTarget();const t=this.getRenderTargetDescriptorForSweep(e);if(!this.isRenderTargetDescriptorValid(t))throw new Z("queueUploadForAllTiles() -> Cannot render to a pano that is not activated.");const i=this.persistentStorage.getArray("queueUploadForAllTiles:nodeList");for(let t=0;t<6;t++){const o=this.getTileTree(e,t);i.length=0,o.breadthFirst({saveVisited:i});for(const e of i)this.queueUploadForTile(e.extra.tile,!1,0===e.level)}}onTileDownLoaded(e){if(!e.sweep)return;const t=H(A,e.panoSize),i=this.getTileDirectoryEntry(e.sweep.id,e.face,t,e.faceTileIndex);this.updateUploadDescriptorFromDownloadDescriptor(i,e),this.updateSweepLoadHistory(i.sweepId);const o=this.getRenderTargetDescriptorForSweep(i.sweepId);if(this.isRenderTargetDescriptorValid(o)){const e=this.getTileTree(i.sweepId,i.face).getSubNode(i.panoSize,i.tileX,i.tileY);e&&(e.extra.tile=i,i.node=e,this.componentActive&&this.queueUploadForTile(i,!0))}}updateUploadDescriptorFromDownloadDescriptor(e,t){var i,o;e.downloaded=!0,e.image&&e.image!==t.image&&(null===(o=(i=e.image).close)||void 0===o||o.call(i)),e.image=t.image,e.panoSize=t.panoSize,e.tileX=t.tileX,e.tileY=t.tileY,e.totalTiles=t.totalTiles,e.tileIndex=t.tileIndex,e.faceTileIndex=t.faceTileIndex,e.face=t.face,e.cubeFace=c(t.face),t.sweep&&(e.sweepId=t.sweep.id),e.tileSize=t.tileSize,e.direction.copy(t.direction),e.node=null,e.level=H(A,e.panoSize)}updateSweepLoadHistory(e){const t=this.persistentStorage.getArray("updateSweepLoadHistory:tempHistory");t.length=0;for(const i of this.sweepLoadHistory)i&&(!e||e&&e!==i)&&t.push(i);this.sweepLoadHistory.length=0,e&&this.sweepLoadHistory.push(e),this.sweepLoadHistory.push(...t)}onPanoRendered(e,t){var i,o;const s=this.panoLoadResolvers[e],r=this.activeRenderTargetDescriptors[e];r&&r.object&&(null===(o=(i=this.panoLoadMinimumCallbacks)[e])||void 0===o||o.call(i),delete this.panoLoadMinimumCallbacks[e],s())}getRenderTargetDescriptorForSweep(e){return this.activeRenderTargetDescriptors[e]}isRenderTargetDescriptorValid(e){return!!e&&!!e.object}isSweepZoomed(e){return this.zoomingActive&&this.zoomSweepId===e}getTileTrees(e){const t=this.tileTrees[e];if(!t)throw new Z("TiledPanoRenderer.getTileTrees() -> Tree array not yet initialized!");return t}checkTileTreeInitialized(e){return!!this.tileTrees[e]}getTileTree(e,t){const i=this.getTileTrees(e)[t];if(!i)throw new Z("TiledPanoRenderer.getTileTree() -> Tree not yet initialized!");return i}deleteTileTrees(e){const t=this.getTileTrees(e);for(let e=0;e<6;e++){const i=t[e];i&&i.deleteAllNodes()}this.tileTrees[e]=null,delete this.tileTrees[e]}clearTileState(e,t=!1,i=!1){const o=(e,o,s,r)=>{var n,a;i&&(null===(a=null===(n=o.extra.tile.image)||void 0===n?void 0:n.close)||void 0===a||a.call(n),o.extra.tile.image=null),t&&(o.extra.tile.uploaded=!1,o.extra.tile.downloaded=!1,o.extra.tile.zoomUploaded=!1,o.extra.tile.uploadAttempted=!1)};for(let t=0;t<6;t++){const i=this.getTileTree(e,t);i&&i.breadthFirst({callback:o.bind(this,t),maxLevel:H(A,this.panoQualityManager.getZoomPanoSize())})}}resetUploadState(e,t,i){const o=(e,o,s,r)=>{o.extra.tile.zoomUploaded=!i&&o.extra.tile.zoomUploaded,o.extra.tile.uploaded=!t&&o.extra.tile.uploaded};for(let t=0;t<6;t++){this.getTileTree(e,t).breadthFirst({callback:o.bind(this,t),minLevel:0})}}anyUploaded(e){if(!e)return!1;if(e.extra.tile&&this.isTileUploaded(e.extra.tile))return!0;if(e.children)for(const t of e.children)if(this.anyUploaded(t))return!0;return!1}getTileDirectoryEntry(e,t,i,o){let s=this.tileDirectory[e];s||(s={},this.tileDirectory[e]=s);const r=16384*t+1024*i+o;let n=s[r];return n||(n={downloaded:!1,uploaded:!1,uploadAttempted:!1,zoomUploaded:!1,uploadQueued:!1,image:null,panoSize:-1,tileX:-1,tileY:-1,totalTiles:-1,tileIndex:o,faceTileIndex:-1,face:t,cubeFace:-1,sweepId:e,tileSize:-1,direction:new a.Vector3,node:null,level:i},s[r]=n),n._tileKey=r,n}deleteTileDirectoryEntries(e){var t,i;const o=this.tileDirectory[e];if(o)for(const e of Object.values(o))e.image&&(null===(i=(t=e.image).close)||void 0===i||i.call(t),e.image=null);delete this.tileDirectory[e]}isTileUploaded(e){return this.isSweepZoomed(e.sweepId)?e.zoomUploaded:e.uploaded}setUploaded(e,t){this.isSweepZoomed(e.sweepId)?e.zoomUploaded=t:e.uploaded=t}queueUploadForTile(e,t,i){const o=!e.downloaded||e.uploadQueued&&!i||this.isTileUploaded(e)||e.panoSize>this.panoQualityManager.getNavPanoSize()&&!this.zoomingActive,s=this.getRenderTargetDescriptorForSweep(e.sweepId);!o&&s&&this.isRenderTargetDescriptorValid(s)&&(i?this.uploadTile(e):(0===H(A,e.panoSize)?this.tileUploadQueue.addToForceQueue(e):t&&this.currentState.direction?this.tileUploadQueue.insertSortedIntoPanoQueue(e,s.extra.sweep,this.currentState.direction):this.tileUploadQueue.addToPanoQueue(e.sweepId,e),e.uploadQueued=!0))}uploadTile(e){const t=this.tileUploadQueue.getPanoLODDescriptor(e.sweepId,e.panoSize),i=this.getRenderTargetDescriptorForSweep(e.sweepId);if(!i||!e.image||!this.isRenderTargetDescriptorValid(i))return;let o=i.object,s=i.extra.size;if(this.isSweepZoomed(e.sweepId)&&(o=this.zoomRenderTarget,s=this.panoQualityManager.getZoomPanoSize()),this.isTileUploaded(e)||this.anyUploaded(e.node))this.setUploaded(e,!1);else{const i=e.tileX*e.tileSize,n=e.tileY*e.tileSize,l=e.tileSize/e.panoSize*s,u=i/e.panoSize*s,h=n/e.panoSize*s;let c=this.tempTileTextures.get(e.tileSize);c||(c=this.cwfRenderer.initSizedTexture2D(e.tileSize,{generateMipmaps:!1,minFilter:a.LinearFilter,flipY:!1}),this.tempTileTextures.set(e.tileSize,c)),this.cwfRenderer.uploadTexture2D(e.image,c,0,0),this.cwfRenderer.renderToCubeMap(c,o,e.tileSize,e.tileSize,0,0,e.tileSize,e.tileSize,u,h,l,l,e.cubeFace),r.W0.overlayStyle>0&&this.cwfRenderer.renderToCubeMap(this.overlayTiles[e.panoSize],o,e.tileSize,e.tileSize,0,0,e.tileSize,e.tileSize,u,h,l,l,e.cubeFace,a.NormalBlending,!0,.5),t.uploadCount++,this.setUploaded(e,!0)}e.uploadAttempted||t.uploadAttempts++,e.uploadAttempted=!0,t.uploadAttempts===e.totalTiles&&this.onPanoRendered(e.sweepId,e.panoSize)}updateUploadQueueProcessing(){if(!this.currentUploadPromise&&(this.overlayTilesLoaded||!this.usingTileOverlay)){const e=new w.m("pano/tiling/upload",(()=>this.engine.after(g.R.End).then((()=>this.processUploadQueue(this.tilingSettings.highResUploadsPerFrame,this.tilingSettings.uploadsPerFrame)))),j);this.currentUploadPromise=this.engine.commandBinder.issueCommand(e).then((async e=>{await e.promise,this.currentUploadPromise=null}))}}processUploadQueue(e=1,t){let i=0,o=0,s=null;for(;s=this.tileUploadQueue.getNextFromUploadQueue(this.activeSweeps);){const r=this.getRenderTargetDescriptorForSweep(s.sweepId);if(!(s.panoSize>this.panoQualityManager.getNavPanoSize()&&!this.zoomingActive||!this.isRenderTargetDescriptorValid(r))&&(this.uploadTile(s),i+=0!==s.level?1:0,o+=0===s.level?1:0,o>=t||i>=e))break}}loadOverlayTiles(){if(0!==r.W0.overlayStyle){let e=0;const t=[],o=(i,o,s)=>{const r=i[o]=this.cwfRenderer.initSizedTexture2D(A,{generateMipmaps:!1,minFilter:a.LinearFilter,flipY:!1});this.cwfRenderer.uploadTexture2D(s,r,0,0),e++,e>=t.length&&(this.overlayTilesLoaded=!0)};switch(r.W0.overlayStyle){case 1:t.push([i(880),this.overlayTiles,256]),t.push([i(9135),this.overlayTiles,512]),t.push([i(29274),this.overlayTiles,1024]),t.push([i(62717),this.overlayTiles,2048]),t.push([i(23169),this.overlayTiles,4096]);break;case 2:t.push([i(81960),this.overlayTiles,256]),t.push([i(89511),this.overlayTiles,512]),t.push([i(51106),this.overlayTiles,1024]),t.push([i(33909),this.overlayTiles,2048]),t.push([i(76486),this.overlayTiles,4096]);break;case 3:t.push([i(13106),this.overlayTiles,256]),t.push([i(4205),this.overlayTiles,512]),t.push([i(56252),this.overlayTiles,1024]),t.push([i(13103),this.overlayTiles,2048]),t.push([i(53384),this.overlayTiles,4096])}t.forEach((e=>{const t=document.createElement("img");t.crossOrigin="anonymous",t.src=e[0],t.onload=()=>{o.call(this,e[1],e[2],t)}})),this.usingTileOverlay=!0}else this.usingTileOverlay=!1}copyTargetToZoom(e){if(!this.zoomingActive)return;const t=this.getRenderTargetDescriptorForSweep(e);if(!t)throw new Z("Error in copying a null render target to a zoomed target");const i=t.object;this.cwfRenderer.copyCubemap(i.texture,this.zoomRenderTarget),this.copyBaseRenderStatusToZoomed(e)}setupZoomRenderTarget(){if(this.panoQualityManager.getZoomPanoSize()>=this.panoQualityManager.getNavPanoSize()){if(this.zoomRenderTarget&&this.zoomRenderTarget.width===this.panoQualityManager.getZoomPanoSize())return;const e=this.zoomRenderTarget;this.zoomRenderTarget=this.cwfRenderer.initRenderTargetCube(this.panoQualityManager.getZoomPanoSize()),e&&(this.cwfRenderer.copyCubemap(e.texture,this.zoomRenderTarget),e.texture.dispose(),e.texture.version=0,e.texture=null),this.zoomSweepRenderingDisabled=!1}else this.zoomSweepRenderingDisabled=!0}}var K,J=i(95330);!function(e){e[e.None=0]="None",e[e.Queued=1]="Queued",e[e.ForceQueued=2]="ForceQueued",e[e.Downloading=3]="Downloading",e[e.Downloaded=4]="Downloaded",e[e.DownloadFailed=5]="DownloadFailed"}(K||(K={}));const ee=K;var te,ie=i(64491),oe=i(52026),se=i(2993),re=i(78229),ne=i(96659);!function(e){e[e.CurrentView=0]="CurrentView",e[e.FullPanorama=1]="FullPanorama"}(te||(te={}));var ae;!function(e){e[e.None=0]="None",e[e.DirectionalFOV=1]="DirectionalFOV"}(ae||(ae={}));class le{getQualityQueueSize(e,t){return e===te.CurrentView?this.currViewQueue[t].value:this.fullPanoQueue[t].value}makeQueueSubscription(e,t,i){return(e===te.CurrentView?this.currViewQueue[t]:this.fullPanoQueue[t]).onChanged(i)}constructor(e,t,i,o){this.panoQualityManager=e,this.tilingSettings=t,this.sweepData=i,this.raycaster=o,this.tempQueue=[],this.priorityCriteria=new ge,this.filterAndPrioritize=(e,t)=>{if(!this.priorityCriteria.sweep)return;const i=void 0!==this.priorityCriteria.upcomingSweeps&&null!==this.priorityCriteria.upcomingSweeps,o=this.tempQueue;o.length=0,this.queueTilesForPano(o,t,this.priorityCriteria.sweep,d.c5.BASE);const s=pe(e,o,!0);this.currViewQueue[d.MF.BASE].value=s,this.fullPanoQueue[d.MF.BASE].value=s,i?this.queueForRestrictedSweeps(e,t):this.priorityCriteria.viewmode!==se.N3.Panorama?this.queueForNonPanoViewmode(e,t):this.queueForPanoViewmode(e,t),this.tilingSettings.downloadFullPano&&this.queueFullPano(e,t)},this.queueRaycast=(()=>{const e=new a.Vector3;return(t,i)=>{if(this.priorityCriteria.sweep)if(this.priorityCriteria.hovered)this.queueTilesForPano(t,i,this.priorityCriteria.hovered,d.c5.BASE);else if(this.raycaster&&this.raycaster.hit){const o=e.copy(this.raycaster.hit.point).sub(this.priorityCriteria.sweep.position),s=this.getSinglePanoInDirection(o),r=this.sweepData.getSweep(s);r&&this.queueTilesForPano(t,i,r,d.c5.BASE)}}})(),this.getSweepIdInLocalDirection=(()=>{const e=new a.Vector3;return t=>{const i=this.priorityCriteria.rotation,o=e.copy(t).applyQuaternion(i);return this.getSinglePanoInDirection(o)}})(),this.persistentStorage=new S,this.maxResolution=e.getNavPanoSize(),this.currViewQueue=ce(),this.fullPanoQueue=ce(),this.isMobileDevice=(0,ie.Fr)()}updateCriteria(e,t,i,o){this.priorityCriteria.sweep=e,this.priorityCriteria.position.copy(t),this.priorityCriteria.direction.copy(i),this.priorityCriteria.rotation.copy(o)}setHoveredSweep(e){this.priorityCriteria.hovered=null!=e?e:null}setUpcomingSweeps(e){this.priorityCriteria.upcomingSweeps=e}clearUpcomingSweeps(){this.priorityCriteria.upcomingSweeps=void 0}setDownloadFOV(e){this.priorityCriteria.fov=e}queueForRestrictedSweeps(e,t){if(!this.priorityCriteria.upcomingSweeps)return;let i=0;for(const o of this.priorityCriteria.upcomingSweeps)if(i++,this.queueTilesForPano(e,t,o,d.c5.BASE),i>=3)break;this.queueFOVStandardNarrow(e,t),this.queueFOVHighNarrow(e,t)}queueForPanoViewmode(e,t){this.queueRaycast(e,t),this.queueFOVStandardNarrow(e,t),this.queueScoredSweeps(e,t),this.queueFOVHighNarrow(e,t),this.isMobileDevice||this.queueWASD(e,t)}queueForNonPanoViewmode(e,t){if(!this.raycaster||!this.raycaster.hit||!this.meshQuery)return 0;const i=(0,oe.I9)(this.sweepData,!1,this.raycaster.hit.intersection,this.meshQuery),o=i.length>0?i[0].sweep:this.sweepData.getClosestSweep(this.raycaster.hit.point,!0);return o?this.queueTilesForPano(e,t,o,d.c5.BASE):0}queueFOVTiles(e,t,i,o){if(!this.priorityCriteria.sweep)return 0;const s=d.oY[t];return this.canDownloadSize(this.priorityCriteria.sweep,t)?this.queueTilesInDirectionForPano(e,o,this.priorityCriteria.sweep,s,this.priorityCriteria.direction,i):0}queueScoredSweeps(e,t){if(this.priorityCriteria.sweep&&this.maxResolution<=2048){const i=this.persistentStorage.getArray("filterAndPrioritize:scoredSweeps");this.populateScoredSweeps(this.priorityCriteria.sweep,i,this.priorityCriteria.direction,6),this.queueTilesForPanos(e,i,t,d.c5.BASE,4)}}queueFOVStandardNarrow(e,t){if(!this.priorityCriteria.sweep)return;const i=this.tempQueue;i.length=0;const{direction:o,fov:s,sweep:r}=this.priorityCriteria,n=this.queueFOVTiles(i,d.MF.STANDARD,s,t);this.sortTiles(i,r,o),pe(e,i),this.currViewQueue[d.MF.STANDARD].value=n,this.fullPanoQueue[d.MF.STANDARD].value=n}queueFOVHighNarrow(e,t){if(!this.priorityCriteria.sweep)return;const i=this.tempQueue;i.length=0;const{fov:o}=this.priorityCriteria,s=this.queueFOVTiles(i,d.MF.HIGH,o,t),r=this.queueFOVTiles(i,d.MF.ULTRAHIGH,o,t);this.sortTiles(i,this.priorityCriteria.sweep,this.priorityCriteria.direction),pe(e,i),this.currViewQueue[d.MF.HIGH].value=s,this.currViewQueue[d.MF.ULTRAHIGH].value=r}queueFullPano(e,t){if(!this.priorityCriteria.sweep)return;const i=this.tempQueue;if(i.length=0,this.maxResolution<=d.c5.HIGH){if(this.canDownloadSize(this.priorityCriteria.sweep,d.MF.HIGH)){const e=this.queueTilesForPano(i,t,this.priorityCriteria.sweep,d.c5.HIGH);this.fullPanoQueue[d.MF.HIGH].value=e}}else if(this.canDownloadSize(this.priorityCriteria.sweep,d.MF.ULTRAHIGH)){const e=this.queueTilesForPano(i,t,this.priorityCriteria.sweep,d.c5.ULTRAHIGH);this.fullPanoQueue[d.MF.ULTRAHIGH].value=e}this.sortTiles(i,this.priorityCriteria.sweep,this.priorityCriteria.direction),pe(e,i,!0)}queueWASD(e,t){const i=this.persistentStorage.getArray("filterAndPrioritize:neighbors")||[];if(i.length=0,!this.priorityCriteria.sweep)return;const o=[v.B1.FORWARD,v.B1.RIGHT,v.B1.LEFT,v.B1.BACK];for(const e of o){const t=this.getSweepIdInLocalDirection(e),o=this.sweepData.getSweep(t);o&&i.push(o)}this.queueTilesForPanos(e,i,t,d.c5.BASE)}canDownloadSize(e,t){const i=d.oY[t],o=this.panoQualityManager.getNavPanoSize()>=i||this.maxResolution>=i&&this.panoQualityManager.getZoomPanoSize()>=i;return e.availableResolution(t)===t&&o}populateScoredSweeps(e,t,i,o){(t=t||[]).length=0;const s=(new a.Vector3).copy(e.position),n=[re.Ol(),re.AU(e),re.fm(s,400),re.jW(s,i,.75)],l=[ne.d$(s,r.W0.navigation.distanceFactor),ne.oW(s,i,r.W0.navigation.directionFactor)],u=this.sweepData.getSweepNeighbours(e),h=this.sweepData.sortByScore(n,l,u);for(let e=0;e<h.length&&e<o;e++){const i=h[e].sweep;t.push(i)}}queueTilesForPanos(e,t,i,o,s){let r=0;for(const n of t){if(r+=this.queueTilesForPano(e,i,n,o)>0?1:0,s&&r>=s)break}return r}queueTilesForPano(e,t,i,o){const s=this.persistentStorage.get("queueTilesForSweep:filterCriteria",(()=>({filter:ae.None})));return this.filterAndQueueTileDownloadDescriptors(e,t,i,o,s)}queueTilesInDirectionForPano(e,t,i,o,s,r){const n=this.persistentStorage.get("queueTilesInDirectionForSweep:panoSpaceDir",(()=>new a.Vector3)),l=this.persistentStorage.get("queueTilesInDirectionForSweep:filterCriteria",(()=>({filter:ae.DirectionalFOV,direction:new a.Vector3,fov:60})));return n.copy(s),C(i.rotation,n),l.direction.copy(n),l.fov=r,this.filterAndQueueTileDownloadDescriptors(e,t,i,o,l)}filterAndQueueTileDownloadDescriptors(e,t,i,o,s){const r=this.persistentStorage.getArray("filterAndQueueTileDownloadDescriptors:descriptors"),n=t.getTileDownloadDescriptors(i,o);r.length=0,this.filterTileDownloadDescriptors(n,r,s);let a=0;for(const t of r)t&&(e.push(t),a++);return a}filterTileDownloadDescriptors(e,t,i){let o,s;if(i.filter===ae.DirectionalFOV)for(o=0;o<e.length;o++)s=e[o],s&&I(s.panoSize,s.tileSize,s.face,s.tileX,s.tileY,i.direction,i.fov)&&t.push(s);else for(o=0;o<e.length;o++)s=e[o],t.push(s);for(o=0;o<t.length;o++)s=t[o],s&&!this.canIncludeDescriptor(s)&&(t[o]=null)}canIncludeDescriptor(e){return e.status!==ee.Downloading&&e.status!==ee.Downloaded}sortTiles(e,t,i){ue.panoSpaceDir.copy(i),C(t.rotation,ue.panoSpaceDir),ue.fovThresholdNarrow=de(this.priorityCriteria.fov),e.sort(he)}insertSortedPanoTile(e,t,i,o){ue.panoSpaceDir.copy(o),C(i.rotation,ue.panoSpaceDir),ue.fovThresholdNarrow=de(this.priorityCriteria.fov);let s=-1;for(let i=0;i<e.length;i++){if(he(t,e[i])<=0){s=i;break}}if(-1===s)e[e.length]=t;else{for(let t=e.length;t>s;t--)e[t]=e[t-1];e[s]=t}}getSinglePanoInDirection(e){const t=this.priorityCriteria.sweep;if(!t)return"";const i=[re.AU(t),re.Ol(),re.jW(t.position,e)],o=[ne.oW(t.position,e),ne.Io(t.position)],s=t.neighbours.filter((e=>{const t=this.sweepData.getSweep(e);return i.every((e=>e(t)))})).map((e=>{const t=this.sweepData.getSweep(e);return{sweepId:e,score:o.reduce(((e,i)=>e+i(t)),0)}})),r=s.reduce(((e,t)=>e.score>t.score?e:t),s[0]);return r?r.sweepId:""}}const ue={panoSpaceDir:new a.Vector3,fovThresholdNarrow:-1},he=(e,t)=>{const i=ue.panoSpaceDir,o=ue.fovThresholdNarrow,s=Math.max(Math.min(i.dot(e.direction),1),-1),r=Math.max(Math.min(i.dot(t.direction),1),-1);return s>=o&&r<o?-1:s<o&&r>=o||e.panoSize>t.panoSize?1:t.panoSize>e.panoSize?-1:-(s-r)};function ce(){return{[d.MF.BASE]:(0,J.p)(0),[d.MF.STANDARD]:(0,J.p)(0),[d.MF.HIGH]:(0,J.p)(0),[d.MF.ULTRAHIGH]:(0,J.p)(0)}}function de(e){return Math.cos(Math.PI/180*(e/2))}function pe(e,t,i=!1){let o=0;if(e&&t)for(const s of t)i&&-1!==e.indexOf(s)||(e.push(s),o++);return o}class ge{constructor(){this.direction=new a.Vector3,this.position=new a.Vector3,this.rotation=new a.Quaternion,this.hovered=null,this.sweep=null,this.viewmode=null,this.fov=120}set({direction:e,fov:t,hovered:i,position:o,rotation:s,sweep:r,upcomingSweeps:n,viewmode:a}){return this.direction.copy(void 0===e?this.direction:e),this.position.copy(void 0===o?this.position:o),this.rotation.copy(void 0===s?this.rotation:s),this.hovered=void 0===i?this.hovered:i,this.sweep=void 0===r?this.sweep:r,this.upcomingSweeps=n,this.viewmode=void 0===a?this.viewmode:a,this.fov=void 0===t?this.fov:t,this}clone(){const e=new ge;return e.set(this),e}}var we=i(97084),Te=i(5544);const fe=new y.Ay("tile-downloader");class Se{constructor(e,t,i,o){this.sweepData=e,this.api=t,this.tilePrioritizer=i,this.settings=o,this.persistentStorage=new S,this.downloadDescriptors={},this.priorityQueue=[],this.forceQueue=[],this.activeDownloads=[],this.lastPrioritizedTime=Date.now(),this.processPriorityQueue=!0}init(){}render(){this.update()}update(){this.processQueue(this.forceQueue,!1),this.processPriorityQueue&&(!this.processQueuePromise&&this.activeDownloads.length<this.settings.concurrentDownloads&&Date.now()-this.lastPrioritizedTime>200&&(this.processQueuePromise=this.engine.commandBinder.issueCommand(new w.m("pano/tiling/queue-download",(()=>{this.queuePrioritizedTiles(),this.lastPrioritizedTime=Date.now()}),100)).then((async e=>{await e.promise,this.processQueuePromise=null}))),this.processQueue(this.priorityQueue,!1))}dispose(){}activate(e){this.engine=e}deactivate(e){}setRestrictedSweeps(e){const t=e.map((e=>this.sweepData.getSweep(e)));this.tilePrioritizer.setUpcomingSweeps(t),this.clearFromAllQueuesBySweep(e)}clearRestrictedSweeps(){this.tilePrioritizer.clearUpcomingSweeps()}setLoadCallbacks(e,t){this.onTileDownloaded=e,this.onPanoDownloaded=t}getNonDownloadedTiles(e,t,i){i.length=0;const o=this.getTileDownloadDescriptors(e,t);for(const e of o)!e||e.status!==ee.None&&e.status!==ee.Queued||i.push(e)}forceQueueTiles(e,t,i,o){const s=this.persistentStorage.getArray("forceQueueTiles:remaining"),r=this.persistentStorage.getArray("forceQueueTiles:matching"),n=this.persistentStorage.getArray("forceQueueTiles:toDownload");if(this.getNonDownloadedTiles(e,t,s),n.length=0,s.length>0){this.tilePrioritizer.sortTiles(s,e,i),r.length=0,M(e,t,i,r,!0);for(const e of s)for(const t of r)e.face===t.face&&e.faceTileIndex===t.faceTileIndex&&n.push(e);this.forceQueue.push(...n),this.setStatusForAllDescriptors(this.forceQueue,ee.ForceQueued),this.clearFromQueue(this.priorityQueue,ee.ForceQueued,!1),o&&this.processQueue(this.forceQueue,!0)}}clearForceQueue(){this.clearQueue(this.forceQueue)}queuePrioritizedTiles(){this.clearQueue(this.priorityQueue),this.tilePrioritizer.filterAndPrioritize(this.priorityQueue,this),this.invalidateDuplicateEntries(this.priorityQueue),this.clearFromQueue(this.priorityQueue,ee.None,!0),this.setStatusForAllDescriptors(this.priorityQueue,ee.Queued),this.lastPrioritizedTime=Date.now()}clearQueue(e){this.setStatusForAllDescriptors(e,ee.None),e.length=0}clearFromQueue(e,t,i){for(let o=0;o<e.length;o++){const s=e[o];s&&(t===s.status&&!i||t!==s.status&&i)&&(e[o]=null)}}clearFromAllQueuesBySweep(e){this.clearFromQueueBySweep(this.forceQueue,e),this.clearFromQueueBySweep(this.priorityQueue,e)}clearFromQueueBySweep(e,t){const i=(0,T.Z9)(t);for(let t=0;t<e.length;t++){const o=e[t];o&&o.sweep&&(i[o.sweep.id]||(e[t]=null))}}setStatusForAllDescriptors(e,t){for(const i of e)i&&(i.status=t)}invalidateDuplicateEntries(e){for(const t of e)t&&(t.queuedCount=0);for(let t=0;t<e.length;t++){const i=e[t];i&&(i.queuedCount++,i.queuedCount>1&&(e[t]=null))}}getTileDownloadDescriptors(e,t){const i=this.getAllTileDownloadDescriptors(e.id);let o=i[t];return o||(o=this.buildDownloadDescriptorArray(t),i[t]=o,this.initTileDownloadDescriptors(o,e,t)),o}getAllTileDownloadDescriptors(e){let t=this.downloadDescriptors[e];return t||(t={},this.downloadDescriptors[e]=t),t}deleteAllTileDownloadDescriptors(e){this.downloadDescriptors[e]=null,delete this.downloadDescriptors[e]}processQueue(e,t){if(this.cleanupActiveDownloads(),this.activeDownloads.length<this.settings.concurrentDownloads||t){const i=t?e.length:this.settings.concurrentDownloads-this.activeDownloads.length;let o=0;for(let t=0;o<i&&e.length>0;t++){const t=e.shift();t&&(this.startDownload(t),o++)}}}async startDownload(e){if(e.sweep){const t=e.status===ee.ForceQueued?we.QK.HIGHEST:we.QK.MEDIUM;e.status=ee.Downloading;this.checkRestrictedSweep(e.sweep.id)||fe.warn("Downloading a tile that is not in restricted list"),this.activeDownloads.push(e);const i=await this.getTileUrl(e.sweep,e.panoSize,e.tileSize,e.tileIndex);this.api.getImageBitmap(i,e.tileSize,e.tileSize,{maxRetries:3,priority:t}).then(this.downloadComplete.bind(this,e),this.downloadFailed.bind(this,e))}}checkRestrictedSweep(e){const t=this.tilePrioritizer.priorityCriteria.upcomingSweeps;if(t){let i=!1;for(const o of t)o&&o.id===e&&(i=!0);return i}return!0}downloadFailed(e,t){e.status=ee.DownloadFailed}downloadComplete(e,t){if(e.sweep&&(e.status=ee.Downloaded,e.image=t,this.onTileDownloaded&&this.onTileDownloaded(e),this.engine.broadcast(new Te.f),this.isPanoDownloaded(e.sweep,e.panoSize))){const t={sweep:e.sweep,tileSize:e.tileSize,panoSize:e.panoSize};this.onPanoDownloaded&&this.onPanoDownloaded(t)}}cleanupActiveDownloads(){const e=this.persistentStorage.getArray("cleanupActiveDownloads:temp");e.length=0;for(const t of this.activeDownloads)t.status!==ee.Downloaded&&t.status!==ee.DownloadFailed&&e.push(t);this.activeDownloads.length=0,this.activeDownloads.push(...e)}isPanoDownloaded(e,t){const i=this.getTileDownloadDescriptors(e,t);if(!i||i.length<=0)return!1;for(const e of i)if(e&&e.status!==ee.Downloaded)return!1;return!0}buildDownloadDescriptorArray(e){const t=b(e),i=[];for(let e=0;e<t;e++){const e=this.buildDownloadDescriptor();i.push(e)}return i}buildDownloadDescriptor(){return{sweep:null,panoSize:-1,tileSize:-1,tileIndex:-1,totalTiles:-1,faceTileIndex:-1,status:ee.None,url:null,image:null,direction:new a.Vector3,face:-1,cubeFace:-1,tileX:-1,tileY:-1,queuedCount:-1}}initTileDownloadDescriptors(e,t,i){for(let o=0;o<e.length;o++){const s=e[o];s&&this.initTileDownloadDescriptor(s,t,i,o)}}initTileDownloadDescriptor(e,t,i,o){const s=i>=A?A:i;e.face=U(i,o),e.cubeFace=c(e.face),e.sweep=t,e.panoSize=i,e.tileSize=s,e.tileIndex=o,e.totalTiles=b(i),e.status=ee.None,e.image=null,x(e.panoSize,e.tileIndex,e),F(e.panoSize,e.tileSize,e.cubeFace,e.tileX,e.tileY,Q.Center,0,e.direction)}getTileUrl(e,t,i,o){const s=this.persistentStorage.get("getTileUrl:locationInfo",(()=>({face:-1,faceTileIndex:-1,tileX:-1,tileY:-1})));x(t,o,s);const r=Math.floor(t/i),n=r*r,a=Math.floor(o/n),l=z.A.getPanoSizeClass(t);return e.getTileUrl(l,a,s.tileX,s.tileY)}}var me=i(35898),De=i(4582),ve=i(31093),ye=i(20599),Pe=i(5243),ze=i(59758),Qe=i(12837),Re=i(18855),Ae=i(31285),Fe=i(45862),Ue=i(70046),xe=i(97171),be=i(79388),Ce=i(10574);class Me extends o.n{constructor(){super(...arguments),this.name="sweep-pano-tiling",this.enum={resolution:d.MF,queueStyle:te},this.preloadQuality=null,this.preloadResolution=null,this.handleResolutionChange=(e,t)=>{const i=this.panoRenderer.getCurrentPanoResolution();this.qualityManager.update({height:this.getVerticalResolution()});i!==this.panoRenderer.getCurrentPanoResolution()&&e&&this.resetPano(e)}}setPreloadQuality(e){this.settingsData.setSetting(r.Oe,e)}async init(e,t){const{market:i}=t,[o,a,l]=await Promise.all([t.getModuleBySymbol(s.qL),t.getModuleBySymbol(s.M7),i.waitForData(Pe.$)]);[this.cameraData,this.settingsData,this.sweepData]=await Promise.all([i.waitForData(ye.M),i.waitForData(ze.o),i.waitForData(Qe.A)]);const u=this.cwfRenderer=a.cwfRenderer,h=a.maxCubemapSize,{navPanoSize:c,zoomPanoSize:p}=function(e){let t=d.c5.STANDARD,i=d.c5.HIGH;return(0,ie.Fr)()?(0,ie.Fr)()&&e&&(t=d.c5.STANDARD,i=d.c5.HIGH):(t=d.c5.HIGH,i=d.c5.ULTRAHIGH),{navPanoSize:t,zoomPanoSize:i}}(a.isHighPerformanceMobileGPU());this.settings=new r.RB,this.qualityManager=new z.A(h,c,p,this.getVerticalResolution()),this.tilePrioritizer=new le(this.qualityManager,this.settings,this.sweepData,l),t.getModuleBySymbol(s.PM).then((e=>this.tilePrioritizer.meshQuery=e)),this.tileDownloader=new Se(this.sweepData,o.getApi(),this.tilePrioritizer,this.settings),this.panoRenderer=new $(u,this.qualityManager,this.tileDownloader,this.tilePrioritizer,this.sweepData,this.cameraData,this.settings),this.tileDownloader.setLoadCallbacks(this.panoRenderer.onTileDownLoaded),t.addComponent(this,this.tileDownloader),t.addComponent(this,this.panoRenderer),this.bindings.push(t.commandBinder.addBinding(Ce.V,(async({navSize:e})=>{this.overrideNavPanoResolutionMax(e)}))),this.bindings.push(t.subscribe(Ae.A,(e=>{this.setTilingFOV()})),t.subscribe(n.h,(()=>{const e=this.setTilingFOV();this.handleResolutionChange(this.sweepData.state.currentSweep,e)})),t.subscribe(be.lo,(()=>{const e=this.setTilingFOV();this.handleResolutionChange(this.sweepData.state.currentSweep,e)})),t.subscribe(me.A,(e=>{this.tileDownloader.setRestrictedSweeps(e.sweepIds)})),t.subscribe(De.A,(e=>{this.tileDownloader.clearRestrictedSweeps()})),t.subscribe(Re.n,(e=>{const t=this.sweepData.getSweep(e.sweepId);this.setHoverPreloadSweep(e.hovered?t:void 0)})),t.subscribe(Fe.Y,(e=>{this.tilePrioritizer.priorityCriteria.viewmode=e.toMode})),this.sweepData.state.transition.onPropertyChanged("active",(()=>{if(this.sweepData.state.transition.to){const e=this.sweepData.getSweep(this.sweepData.state.transition.to);this.handlePreloadQualityChange(e),this.enableHighRes(!1)}})),this.settingsData.onSettingChanged(r.Oe,(()=>{if(this.preloadQuality=this.settingsData.tryGetSetting(r.Oe,null),this.qualityManager.overrideWindowMaximums(null!==this.preloadQuality),this.sweepData.currentSweepObject){const e=this.sweepData.currentSweepObject;this.handlePreloadQualityChange(e),this.preloadQuality===d.MF.ULTRAHIGH&&this.panoRenderer.enableUltraHighQualityMode(e.id);const t=this.preloadQuality===d.MF.HIGH||this.preloadQuality===d.MF.ULTRAHIGH;this.enableHighRes(t,e.id),this.resetPano(e.id)}})),t.subscribe(be.ul,(()=>{this.panoRenderer.deactivate()})),t.subscribe(be.aF,(()=>{this.panoRenderer.activate(t)}))),this.setTilingFOV(),t.broadcast(new Ue.sb(xe.D.PanoTiles))}getVerticalResolution(){return this.cwfRenderer.getSize().height*this.cwfRenderer.getPixelRatio()}overrideNavPanoResolutionMax(e){const t=d.oY[null!=e?e:this.panoRenderer.getCurrentPanoResolution()],i=null!==this.settingsData.tryGetSetting(r.Oe,null);this.qualityManager.overrideWindowMaximums(i),this.qualityManager.overrideNavPanoSize(t)}setTilingFOV(){const e=this.cameraData.fovX(),t=this.cameraData.fovY(),i=Math.max(e,t)*R.tm;return this.tilePrioritizer.setDownloadFOV(i),i}getRenderer(){return this.panoRenderer}setHoverPreloadSweep(e){this.tilePrioritizer&&this.tilePrioritizer.setHoveredSweep(e)}handlePreloadQualityChange(e){if(null!==this.preloadQuality){const t=e.availableResolution(this.preloadQuality);this.preloadResolution=z.A.getPanoSize(t)}else this.preloadResolution=null}enableHighRes(e=!0,t){const i=null!==this.preloadResolution?this.preloadResolution:e?this.qualityManager.getZoomPanoSize():this.qualityManager.getNavPanoSize();this.tilePrioritizer.maxResolution!==i&&y.Ay.for(this).debug(`Setting max resolution: ${i}`),this.tilePrioritizer.maxResolution=i,this.panoRenderer.highResRenderTarget(e,t)}enableZooming(e,t){if(e){const e=z.A.getPanoSizeClass(this.qualityManager.getZoomPanoSize());return this.requestResolution({sweepId:t,resolution:e}).res>=e}return this.enableHighRes(!1,t),this.resetPano(t),!1}requestResolution({onProgress:e,queueType:t=te.CurrentView,quickly:i=!1,resolution:o,sweepId:s,timeout:n=1e3}){const a=this.sweepData.getSweep(s);this.settings.highResUploadsPerFrame=i?r.W0.maxHighResUploadsPerFrame:r.W0.highResUploadsPerFrame,this.settings.concurrentDownloads=i?r.W0.maxConcurrentDownloads:r.W0.concurrentDownloads,this.settings.downloadFullPano=t===te.FullPanorama;const l=a.availableResolution(o),u=d.oY[l];u>d.c5.HIGH&&(this.qualityManager.overrideWindowMaximums(!0),this.panoRenderer.enableUltraHighQualityMode(a.id));(u>d.oY[this.panoRenderer.getCurrentPanoResolution()]||u>this.qualityManager.getNavPanoSize())&&(this.enableHighRes(!0,a.id),this.resetPano(a.id));const h=this.waitForQueue(t,o,n);return e&&h.progress(e),{res:l,promise:h.nativePromise()}}waitForQueue(e,t,i=1e3){const o=new ve.i,s=()=>{a.cancel(),o.notify(1),o.resolve()};let r=this.tilePrioritizer.getQualityQueueSize(e,t),n=window.setTimeout((()=>{y.Ay.for(this).debug(`Download queue ${e} timed out from inactivity after ${i}ms`),s()}),i);const a=this.tilePrioritizer.makeQueueSubscription(e,t,(e=>{if(n&&(window.clearTimeout(n),n=0,r=e),e>0){const t=(r-e)/Math.max(r,1);o.notify(t)}else s()}));return o.promise()}resetSweep(e){this.enableHighRes(!1,e),this.resetPano(e),this.settings.reset()}resetPano(e){this.panoRenderer.resetRenderStatus(e,!1,!0,this.panoRenderer.panoQualityManager.getNavPanoSize()),this.panoRenderer.clearAllQueuedUploadsForPano(e),this.panoRenderer.renderPanoTiles(e,null,!1,!1)}}},5544:(e,t,i)=>{i.d(t,{f:()=>s});var o=i(89103);class s extends o.QB{constructor(){super()}}},4582:(e,t,i)=>{i.d(t,{A:()=>s});var o=i(89103);class s extends o.QB{constructor(){super()}}},35898:(e,t,i)=>{i.d(t,{A:()=>s});var o=i(89103);class s extends o.QB{constructor(e){super(),this.sweepIds=e}}},79388:(e,t,i)=>{i.d(t,{aF:()=>n,lo:()=>s,ul:()=>r});var o=i(89103);class s extends o.QB{constructor(e){super(),this.pixelRatio=e}}class r extends o.QB{constructor(e){super(),this.event=e}}class n extends o.QB{constructor(e){super(),this.event=e}}},31285:(e,t,i)=>{i.d(t,{A:()=>s});var o=i(89103);class s extends o.QB{constructor(e){super(),this.zoomLevel=e}}},73586:(e,t,i)=>{i.d(t,{i:()=>r});var o=i(76185),s=i(31093);class r{constructor(e){this.waitingGets=new Map,this.comparer=e||this.defaultComparer,this.poolArray=[]}add(e,t=!0){const i=this.createObjectDescriptor(e);return i.object=e,i.inUse=t,this.addObjectDescriptorToPool(i),i}get(e){for(const t of this.poolArray)if(!t.inUse&&this.comparer(t,e))return t.inUse=!0,t;return null}async tryGetAndWait(e){const t=this.get(e);if(t)return Promise.resolve(t);{const t=e||"no-criteria";this.waitingGets.has(t)||this.waitingGets.set(t,[]);const i=this.waitingGets.get(t);(0,o.$)(i);const r=new s.i;return i.push(r),r.nativePromise()}}free(e){for(const t of this.poolArray)if(t.object===e){const e=this.isWaitingForObject(t);return e?e.resolve(t):t.inUse=!1,!0}return!1}isWaitingForObject(e){if(this.waitingGets.size>0)for(const[t,i]of this.waitingGets.entries())if(i.length>0){if("no-criteria"===t||this.comparer(e,t)){const e=i.shift();if(e)return e}}return null}all(){return this.poolArray}defaultComparer(e,t){return!0}createObjectDescriptor(e){return{object:e,inUse:!1}}addObjectDescriptorToPool(e){this.poolArray.push(e)}}},29274:(e,t,i)=>{e.exports=i.p+"images/outlineBasic1024.png"},62717:(e,t,i)=>{e.exports=i.p+"images/outlineBasic2048.png"},880:(e,t,i)=>{e.exports=i.p+"images/outlineBasic256.png"},23169:(e,t,i)=>{e.exports=i.p+"images/outlineBasic4096.png"},9135:(e,t,i)=>{e.exports=i.p+"images/outlineBasic512.png"},51106:(e,t,i)=>{e.exports=i.p+"images/outlineEnhanced1024.png"},33909:(e,t,i)=>{e.exports=i.p+"images/outlineEnhanced2048.png"},81960:(e,t,i)=>{e.exports=i.p+"images/outlineEnhanced256.png"},76486:(e,t,i)=>{e.exports=i.p+"images/outlineEnhanced4096.png"},89511:(e,t,i)=>{e.exports=i.p+"images/outlineEnhanced512.png"},56252:(e,t,i)=>{e.exports=i.p+"images/outlineFilled1024.png"},13103:(e,t,i)=>{e.exports=i.p+"images/outlineFilled2048.png"},13106:(e,t,i)=>{e.exports=i.p+"images/outlineFilled256.png"},53384:(e,t,i)=>{e.exports=i.p+"images/outlineFilled4096.png"},4205:(e,t,i)=>{e.exports=i.p+"images/outlineFilled512.png"}}]);